{% extends "base.html" %}

{% block title %}Rebuild Site - {{ site.name }}{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-100 py-6">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Back Button -->
        <div class="mb-6">
            <a href="{{ url_for('site_details', site_id=site.domain_name) }}" class="inline-flex items-center text-gray-600 hover:text-gray-900">
                <i class="fas fa-arrow-left mr-2"></i>
                Back to Site Details
            </a>
        </div>

        <div class="grid grid-cols-12 gap-6">
            <!-- Left Column: Site Info -->
            <div class="col-span-12 lg:col-span-5 space-y-6">
                <!-- Status Section -->
                <div class="bg-white shadow rounded-lg">
                    <div class="px-6 py-5">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 bg-orange-500 rounded-md p-3">
                                    <i class="fas fa-sync-alt text-white text-2xl"></i>
                                </div>
                                <div class="ml-4">
                                    <h1 class="text-2xl font-bold text-gray-900">{{ site.name }}</h1>
                                    <p class="text-sm text-gray-500 mt-1">Rebuilding Site</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Site Information -->
                <div class="bg-white shadow rounded-lg">
                    <div class="px-6 py-5">
                        <h2 class="text-lg font-medium text-gray-900 mb-4">Site Information</h2>
                        <div class="grid grid-cols-1 gap-6">
                            <div class="border-b pb-4">
                                <h3 class="text-sm font-medium text-gray-500">Domain</h3>
                                <p class="mt-1 text-lg text-gray-900">
                                    <i class="fas fa-link mr-2 text-gray-400"></i>
                                    {{ site.domain_name }}
                                </p>
                            </div>
                            <div class="border-b pb-4">
                                <h3 class="text-sm font-medium text-gray-500">Local URL</h3>
                                <p class="mt-1 text-lg text-gray-900">
                                    <i class="fas fa-server mr-2 text-gray-400"></i>
                                    {{ site.IP_URL }}
                                </p>
                            </div>
                            <div>
                                <h3 class="text-sm font-medium text-gray-500">Repository</h3>
                                <p class="mt-1 text-lg text-gray-900">
                                    <i class="fab fa-github mr-2 text-gray-400"></i>
                                    {{ site.repo }}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Rebuild Logs -->
            <div class="col-span-12 lg:col-span-7 space-y-6">
                <!-- Rebuild Log Section -->
                <div class="bg-white shadow rounded-lg">
                    <div class="px-6 py-5">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-lg font-medium text-gray-900">Rebuild Logs</h2>
                            <span id="rebuild-status" class="px-3 py-1 text-sm rounded-full inline-flex items-center bg-gray-100 text-gray-800">
                                <i class="fas fa-circle text-xs mr-2"></i>
                                Waiting for updates...
                            </span>
                        </div>
                        <div class="bg-gray-900 rounded-lg p-4 h-96 overflow-y-auto font-mono text-sm text-gray-300">
                            <div id="rebuild-log-content" class="whitespace-pre-wrap"></div>
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="bg-white shadow rounded-lg">
                    <div class="px-6 py-5">
                        <div class="space-y-4">
                            <!-- Main Rebuild Button -->
                            <div class="space-y-4">
                                <button id="startRebuildBtn" onclick="startRebuild('{{ site.domain_name }}')"
                                    class="w-full inline-flex justify-center items-center px-6 py-4 text-base font-medium rounded-lg bg-gradient-to-r from-blue-500 to-blue-600 text-white hover:from-blue-600 hover:to-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-500/50 transition-all duration-200 shadow-md hover:shadow-lg border-0">
                                    <i id="startRebuildIcon" class="fas fa-sync-alt mr-3 text-lg text-blue-100"></i>
                                    <span id="startRebuildText" class="font-semibold">Start Rebuild</span>
                                    <span class="ml-2 bg-blue-700 text-white text-xs px-2 py-1 rounded-full">Rebuild Now</span>
                                    <div id="startRebuildSpinner" class="hidden ml-2">
                                        <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                    </div>
                                </button>

                                <!-- Back Button -->
                                <a href="{{ url_for('site_details', site_id=site.domain_name) }}"
                                    class="w-full inline-flex justify-center items-center px-6 py-4 text-base font-medium rounded-lg bg-gradient-to-r from-gray-50 to-gray-100 text-gray-700 hover:from-gray-100 hover:to-gray-200 focus:outline-none focus:ring-4 focus:ring-gray-200 transition-all duration-200 shadow-md hover:shadow-lg border border-gray-200">
                                    <i class="fas fa-arrow-left mr-3 text-lg text-gray-500"></i>
                                    <span class="font-semibold">Back to Site Details</span>
                                    <span class="ml-2 bg-gray-200 text-gray-600 text-xs px-2 py-1 rounded-full">Return</span>
                                </a>

                                <!-- Site Status Info -->
                                <div class="mt-4 p-4 rounded-lg bg-gray-50 border border-gray-200">
                                    <div class="flex items-center space-x-2 text-sm text-gray-600">
                                        <i class="fas fa-info-circle text-blue-500"></i>
                                        <span>Current Site Status:</span>
                                        <span class="px-2 py-1 rounded-full text-xs 
                                            {% if site.status == 'live' %}bg-green-100 text-green-800
                                            {% else %}bg-yellow-100 text-yellow-800{% endif %}">
                                            {{ site.status|title }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const rebuildLogContent = document.getElementById('rebuild-log-content');
const rebuildStatus = document.getElementById('rebuild-status');
const socket = io();
const domainName = "{{ site.domain_name }}";

// Load existing logs when page loads
async function loadExistingLogs() {
    try {
        const response = await fetch(`/get-rebuild-logs/${encodeURIComponent(domainName)}`);
        if (response.ok) {
            const data = await response.json();
            if (data.status === 'success' && data.logs) {
                // Split logs by newline and append each line
                const logLines = data.logs.split('\n');
                logLines.forEach(line => {
                    if (line.trim()) {
                        const match = line.match(/\[(.*?)\] (.*?) (.*)/);
                        if (match) {
                            const [, timestamp, status, message] = match;
                            let type = 'info';
                            if (status.includes('❌')) type = 'error';
                            if (status.includes('✅')) type = 'success';
                            appendLog(message, type);
                        } else {
                            appendLog(line, 'info');
                        }
                    }
                });
            }
        }
    } catch (error) {
        console.error('Error loading existing logs:', error);
        appendLog('Error loading existing logs', 'error');
    }
}

// Load existing logs when page loads
document.addEventListener('DOMContentLoaded', loadExistingLogs);

// Function to update status indicator
function updateStatus(isActive = false) {
    rebuildStatus.className = `px-3 py-1 text-sm rounded-full inline-flex items-center ${
        isActive ? 'bg-orange-100 text-orange-800' : 'bg-gray-100 text-gray-800'
    }`;
    const icon = rebuildStatus.querySelector('i');
    icon.className = `fas fa-circle text-xs mr-2 ${isActive ? 'text-orange-500' : 'text-gray-500'}`;
    rebuildStatus.querySelector('span') && rebuildStatus.removeChild(rebuildStatus.querySelector('span'));
    rebuildStatus.appendChild(document.createTextNode(
        isActive ? 'Rebuild in Progress' : 'Waiting for updates...'
    ));
}

// Function to append log message
function appendLog(message, type = 'info') {
    const timestamp = new Date().toLocaleTimeString();
    const colorClass = type === 'error' ? 'text-red-400' : 
                      type === 'success' ? 'text-green-400' : 
                      'text-gray-300';
    
    const logLine = document.createElement('div');
    logLine.className = `${colorClass} font-mono text-sm`;
    
    // Format the message based on type
    let icon = '';
    if (type === 'error') {
        icon = '❌ ';
    } else if (type === 'success') {
        icon = '✅ ';
    } else {
        icon = 'ℹ️ ';
    }
    
    logLine.innerHTML = `[${timestamp}] ${icon}${message}`;
    rebuildLogContent.appendChild(logLine);
    rebuildLogContent.scrollTop = rebuildLogContent.scrollHeight;
}

// Listen for rebuild updates for this specific site
socket.on(`log_update_${domainName}`, function(data) {
    console.log('Received log update:', data);
    
    // Update status indicator
    updateStatus(data.status === 'running');
    
    // Append log message
    appendLog(data.message, data.status);
    
    // Handle completion
    if (data.status === 'success' || data.status === 'error') {
        console.log('Rebuild process completed with status:', data.status);
        const btn = document.getElementById('startRebuildBtn');
        const spinner = document.getElementById('startRebuildSpinner');
        const text = document.getElementById('startRebuildText');
        const icon = document.getElementById('startRebuildIcon');
        
        btn.disabled = false;
        spinner.classList.add('hidden');
        icon.classList.remove('hidden');
        text.textContent = 'Start Rebuild';
        
        if (data.status === 'success') {
            appendLog('✓ Rebuild completed successfully', 'success');
            setTimeout(() => window.location.href = `/site/${encodeURIComponent(domainName)}`, 2000);
        } else {
            appendLog('✗ Rebuild failed', 'error');
        }
    }
});

// Handle socket connection events
socket.on('connect', function() {
    console.log('Connected to server');
});

socket.on('disconnect', function() {
    console.log('Disconnected from server');
    updateStatus(false);
    appendLog('Lost connection to server', 'error');
});

socket.on('connect_error', function(error) {
    console.error('Connection Error:', error);
    appendLog('Failed to connect to server', 'error');
});

async function startRebuild(domainName) {
    const btn = document.getElementById('startRebuildBtn');
    const spinner = document.getElementById('startRebuildSpinner');
    const text = document.getElementById('startRebuildText');
    const icon = document.getElementById('startRebuildIcon');

    try {
        // Disable button and show spinner
        btn.disabled = true;
        spinner.classList.remove('hidden');
        icon.classList.add('hidden');
        text.textContent = 'Rebuilding...';
        updateStatus(true); // Set status to active immediately

        // Clear previous logs
        rebuildLogContent.innerHTML = '';
        appendLog('Starting rebuild process...', 'info');
        
        const response = await fetch(`/start-rebuild/${encodeURIComponent(domainName)}`, {
            method: 'POST'
        });

        if (!response.ok) {
            throw new Error('Failed to start rebuild process');
        }

        const data = await response.json();
        appendLog('Rebuild request sent successfully', 'success');
        
        // Keep button disabled and spinner visible while rebuild is in progress
        // The socket.io event handlers will handle the completion state
    } catch (error) {
        console.error('Error:', error);
        appendLog(`Error: ${error.message}`, 'error');
        updateStatus(false);
        
        // Reset button on error
        btn.disabled = false;
        spinner.classList.add('hidden');
        icon.classList.remove('hidden');
        text.textContent = 'Start Rebuild';
    }
}
</script>
{% endblock %}
